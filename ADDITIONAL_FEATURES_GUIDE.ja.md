# 追加機能ガイド

このドキュメントは、`ComfyUI-FramePackWrapper_PlusOne`に追加された、パフォーマンスの最適化や機能拡張に関する高度なオプションについて解説します。

これらの設定を理解し調整することで、お使いのPC環境に合わせて、パフォーマンスと安定性の最適なバランスを見つけることができます。

---

## 目次

- [第1章: LoRAマージ時のVRAM管理戦略](#1-loraマージ時のvram管理戦略)
  - [`gpu_memory_preservation`](#11-gpu_memory_preservation)
  - [`lora_vram_strategy`](#12-lora_vram_strategy)
- [第2章: MagCacheによるサンプリング高速化](#2-magcacheによるサンプリング高速化)
  - [使い方](#21-使い方)
  - [キャリブレーションモード](#22-キャリブレーションモードについて)
- [第3章: RoPEスケーリングによる高解像度対応](#3-ropeスケーリングによる高解像度対応)
  - [機能が有効なノード](#31-機能が有効なノード)
  - [パラメータの説明](#32-パラメータの説明)

---

## 1. LoRAマージ時のVRAM管理戦略

`LoadFramePackModel`ノードに追加されたこれらの機能は、LoRAマージ時のVRAM（GPUメモリ）管理を最適化します。

### 1.1. `gpu_memory_preservation`

このオプションは、LoRAのマージ処理中に**常に確保しておきたいVRAMの空き容量**をGB（ギガバイト）単位で指定します。

-   **デフォルト値**: `6.0` GB
-   **目的**: マージ処理中にVRAMをすべて使い切ってしまい、OSや他のアプリケーションが不安定になることを防ぎます。Webブラウザを開きながら、あるいは他の作業をしながらComfyUIを実行する場合に特に重要です。
-   **設定のヒント**:
    -   PCに搭載されているVRAM容量が大きい（例: 24GB以上）場合は、この値を少し減らしてパフォーマンスを向上させることができます。
    -   VRAM容量が少ない（例: 8GBなど）場合や、他のGPUアプリケーションを同時に実行している場合は、この値を少し増やすと安定性が向上する可能性があります。

### 1.2. `lora_vram_strategy`

このオプションは、LoRAのマージ処理中にVRAMの空き容量が`gpu_memory_preservation`で指定した値を下回った場合の**具体的な振る舞い（戦略）**を選択します。

#### `KeepUntilFull` (デフォルト)

この戦略は、「VRAMがいっぱいになるまでGPUにデータを詰め込み、いっぱいになったら残りはすべてCPUに送る」というシンプルな動作をします。

-   **長所**: 一度VRAMに配置されたテンソルは、処理中にCPUへ移動することがないため、特定のモジュールへのアクセスが常に高速です。
-   **短所**: モデルの前半部分のモジュールだけがVRAMに乗り、より重要かもしれないモデルの後半部分のモジュールがCPUに配置されてしまう可能性があります。

#### `Rotate`

この戦略は、「VRAMがいっぱいになったら、一度VRAMを空にして、再びGPUにデータを詰め込み始める」という、ローテーションのような動作をします。

-   **長所**: モデルの後半部分のモジュールがVRAM上に残る可能性が高まります。モデルの構造によっては、こちらの方が推論パフォーマンスが向上する場合があります。
-   **短所**: VRAMとCPU間でのデータ転送が複数回発生する可能性があるため、マージ処理全体の時間がわずかに長くなることがあります。

---

## 2. MagCacheによるサンプリング高速化

`magcache`は、サンプリング処理を高速化するためのキャッシュ機能です。特に、step数が大きい場合や、高解像度の画像を生成する際に、計算の一部をキャッシュして再利用することで、2回目以降のサンプリングを大幅に高速化します。

### 2.1. 使い方

`magcache`は、各種サンプラーノードで利用できます。以下のオプションが追加されています。

-   **`enable_magcache`**: `magcache`機能を有効にします。(デフォルト: `false`)
-   **`magcache_retention_ratio`**: キャッシュの保持率。メモリ使用量と速度のトレードオフを調整します。(デフォルト: `0.2`)
-   **`magcache_threshold`**: キャッシュ適用の閾値。小さいほど適用されやすくなります。(デフォルト: `0.24`)
-   **`magcache_k`**: 連続してキャッシュをスキップできる最大ステップ数。(デフォルト: `6`)
-   **`magcache_mag_ratios_str`**: 各ステップのキャッシュ倍率を文字列で指定します。キャリブレーションモードで推奨値を取得できます。(デフォルト: `""`)
-   **`magcache_calibration`**: キャリブレーションモードを有効にします。(デフォルト: `false`)

### 2.2. キャリブレーションモードについて

このモードは、現在のモデルや設定に最適な`magcache_mag_ratios_str`の値を見つけるための機能です。

1.  `magcache_calibration`を`true`にしてサンプリングを実行します。
2.  コンソールに出力される`Suggested --magcache_mag_ratios (copy and paste):`の下の数値をコピーします。
3.  `magcache_calibration`を`false`に戻し、コピーした文字列を`magcache_mag_ratios_str`に貼り付けます。

### 2.3. 注意点

-   **`TEACache`との併用不可**: 両方を有効にすると、`TEACache`が無効になります。
-   **初回実行時の速度**: キャッシュを生成するため、初回実行は通常と同じか僅かに遅くなる場合があります。
-   **生成結果の変化**: `magcache`を使用すると、生成結果が僅かに変化することがあります。

---

## 3. RoPEスケーリングによる高解像度対応

`rope_scaling_factor`は、モデルが学習した解像度やアスペクト比とは異なるサイズの画像を生成する際の品質を向上させる機能です。

### 3.1. 機能が有効なノード

-   `FramePackSingleFrameSampler`
-   `FramePackSampler_F1`

### 3.2. パラメータの説明

#### `rope_scaling_factor`

-   **目的**: 位置エンコーディングのスケーリング係数を指定します。
-   **デフォルト値**: `1.0` (スケーリングなし)
-   **説明**: `1.0`より大きくすると、より大きな解像度に対応できますが、品質とのトレードオフがあります。通常は`1.0`から`2.0`の範囲で微調整します。

#### `rope_scaling_timestep_threshold`

-   **目的**: スケーリングが有効になるサンプリングステップの閾値を指定します。
-   **デフォルト値**: `400.0`
-   **説明**: 生成プロセスのどの段階からスケーリングを適用するかを制御します。通常、このパラメータを変更する必要はありません。

### 3.3. 使い方と推奨設定

高解像度画像や異なるアスペクト比の画像を生成する際に、構図やディテールが不自然な場合に`rope_scaling_factor`の値を少しずつ（例: `1.1`, `1.2`）上げて試すことを推奨します。